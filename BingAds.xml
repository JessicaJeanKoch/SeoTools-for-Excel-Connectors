<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Ads" Title="Bing Ads" Id="BingAds" RequireVersion="7.0" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/BingAds.xml" HelpUrl="http://seotoolsforexcel.com/bing-ads/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <DefaultOAuthAuthenticator StayAuthenticated="true" TokenName="access_token" AuthUrl="https://login.live.com/oauth20_authorize.srf?client_id=a688826e-d804-4c17-9317-e898b3508c99&amp;scope=bingads.manage&amp;response_type=token&amp;redirect_uri={0}&amp;state=hf7FD437we89"
  />

  <Resources>
    <Resource Id="Fail">
      <Fail>
        <XPath Expr="//faultstring"/>
      </Fail>
    </Resource>
  </Resources>

  <RestConnector Id="GetCustomers" Title="Customers" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/getaccountsinfo?view=bingads-12">
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization"><![CDATA[Bearer @(Model.Authenticator.Token)]]></Header>
          <Header Name="SOAPAction">GetCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
          <s:Envelope xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header xmlns="https://bingads.microsoft.com/Customer/v12">
              <Action mustUnderstand="1">GetCustomersInfo</Action>
              <AuthenticationToken i:nil="false">@(Model.Authenticator.Token)</AuthenticationToken>
              <DeveloperToken i:nil="false">119C9YN00G530945</DeveloperToken>
            </s:Header>
            <s:Body>
              <GetCustomersInfoRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <CustomerNameFilter i:nil="false">ValueHere</CustomerNameFilter>
                <TopN>1000</TopN>
              </GetCustomersInfoRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="test" Id="test" Name="test"/>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetAccountDetailed" Title="Accounts (Detailed)" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/searchaccounts?view=bingads-12">
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization"><![CDATA[Bearer @(Model.Authenticator.Token)]]></Header>
          <Header Name="SOAPAction">SearchAccounts</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
          <s:Envelope xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header xmlns="https://bingads.microsoft.com/Customer/v12">
              <Action mustUnderstand="1">SearchAccounts</Action>
              <AuthenticationToken i:nil="false">@(Model.Authenticator.Token)</AuthenticationToken>
              <DeveloperToken i:nil="false">119C9YN00G530945</DeveloperToken>
            </s:Header>
            <s:Body>
              <SearchAccountsRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <Predicates xmlns:e263="https://bingads.microsoft.com/Customer/v12/Entities" i:nil="false">
                  <e263:Predicate>
                    <e263:Field i:nil="false">AccountName</e263:Field>
                    <e263:Operator>Contains</e263:Operator>
                    <e263:Value i:nil="false">a</e263:Value>
                  </e263:Predicate>
                </Predicates>
                <Ordering xmlns:e264="https://bingads.microsoft.com/Customer/v12/Entities" i:nil="false">
                  <e264:OrderBy>
                    <e264:Field>Id</e264:Field>
                    <e264:Order>Descending</e264:Order>
                  </e264:OrderBy>
                </Ordering>
                <PageInfo xmlns:e265="https://bingads.microsoft.com/Customer/v12/Entities" i:nil="false">
                  <e265:Index>0</e265:Index>
                  <e265:Size>10</e265:Size>
                </PageInfo>
              </SearchAccountsRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='accounts']/*[name()='a:advertiseraccount']">
        <Xpath Expr="./*[name()='a:id']" Id="Id" Title="Id"/>
        <Xpath Expr="./*[name()='a:billtocustomerid']" Id="BillToCustomerId" Title="Bill to Customer"/>
        <Xpath Expr="./*[name()='a:currencycode']" Id="CurrencyCode" Title="Currency Code"/>
        <Xpath Expr="./*[name()='a:accountfinancialstatus']" Id="FinancialStatus" Title="Financial Status"/>
        <Xpath Expr="./*[name()='a:language']" Id="Language" Title="Language"/>
        <Xpath Expr="./*[name()='a:name']" Id="Name" Title="Name"/>
        <Xpath Expr="./*[name()='a:number']" Id="Number" Title="Account Number"/>
        <Xpath Expr="./*[name()='a:paymentmethodtype']" Id="PaymentMethodType" Title="Payment Method Type"/>
        <Xpath Expr="./*[name()='a:accountlifecyclestatus']" Id="Status" Title="Status"/>
        <Xpath Expr="./*[name()='a:timezone']" Id="Timezone" Title="Timezone"/>
        <Xpath Expr="./*[name()='a:billingthresholdamount']" Id="BillingThresholdAmount" Title="BillingThresholdAmount"/>
        <!--<Xpath Expr="./*[name()='']" Id="" Title=""/>-->
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetAccountsBasic" Title="Accounts (Basic)" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/searchaccounts?view=bingads-12">
    <Parameters>
      <Text Id="Email" Title="Email" Required="true"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">FindAccountsOrCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header>
              <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
              <h:DeveloperToken xmlns:h="https://bingads.microsoft.com/Customer/v12">119C9YN00G530945</h:DeveloperToken>
              <h:Password i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:UserName xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Email)</h:UserName>
            </s:Header>
            <s:Body>
              <FindAccountsOrCustomersInfoRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <Filter/>
                <TopN>1000</TopN>
              </FindAccountsOrCustomersInfoRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
        <Xpath Expr="//*[name()='accountinfowithcustomerdata']/*[name()='a:accountinfowithcustomerdata']" Id="asd">
          <Xpath Expr="./*[name()='a:customerid']" Id="Id" Title="Id"/>
          <Xpath Expr="./*[name()='a:customername']" Id="Name" Title="Name"/>
          <Xpath Expr="./*[name()='a:accountname']" Id="AccountName" Title="Account Name"/>
          <Xpath Expr="./*[name()='a:accountid']" Id="AccountId" Title="Account Id"/>
          <Xpath Expr="./*[name()='a:accountnumber']" Id="AccountNumber" Title="Account Number" Converter="Int"/>
          <Xpath Expr="./*[name()='a:accountlifecyclestatus']" Id="Status" Title="Status"/>
        </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetAccountsHidden" Hidden="True" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/searchaccounts?view=bingads-12">
    <Parameters>
      <Text Id="Email" Title="Email" Required="true"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">FindAccountsOrCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header>
              <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
              <h:DeveloperToken xmlns:h="https://bingads.microsoft.com/Customer/v12">119C9YN00G530945</h:DeveloperToken>
              <h:Password i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:UserName xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Email)</h:UserName>
            </s:Header>
            <s:Body>
              <FindAccountsOrCustomersInfoRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <Filter/>
                <TopN>1000</TopN>
              </FindAccountsOrCustomersInfoRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='accountinfowithcustomerdata']/*[name()='a:accountinfowithcustomerdata']">
        <Compute Id="Name">
          <Compute.Expr>
            <![CDATA[
            @{
              string name = "";
              name += Model.CustomerName + " - " + Model.AccountName;
            }
            @name
            ]]>
          </Compute.Expr>
          <Xpath Expr="./*[name()='a:customername']" Id="CustomerName"/>
          <Xpath Expr="./*[name()='a:accountname']" Id="AccountName"/>
        </Compute>
        <Xpath Expr="./*[name()='a:accountid']" Id="AccountId" Title="Account Id"/>
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetCampaigns" Title="Campaigns" HelpUrl="https://docs.microsoft.com/en-us/bingads/campaign-management-service/getcampaignsbyaccountid?view=bingads-12">
    <Parameters>
      <Text Id="Email" Title="Email" Required="true"/>
      <Text Id="AccountId" Title="Account Id" Required="true" Select.Connector="GetAccountsHidden" Select.IdField="AccountId" Select.TitleField="Name"/>
      <Select Id="Type" Title="Type" DefaultValue="Search" Required="true">
        <DataSource>
          <!--MultiSelect-->
          <Item Id="Search" Title="Search"/>
          <Item Id="Shopping" Title="Shopping"/>
          <Item Id="DynamicSearchAds" Title="Dynamic Search Ads"/>
        </DataSource>
      </Select>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">FindAccountsOrCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header>
              <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
              <h:DeveloperToken xmlns:h="https://bingads.microsoft.com/Customer/v12">119C9YN00G530945</h:DeveloperToken>
              <h:Password i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:UserName xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Email)</h:UserName>
            </s:Header>
            <s:Body>
              <GetCampaignsByAccountIdRequest	xmlns="https://bingads.microsoft.com/CampaignManagement/v12">
					      <AccountId>@(Model.AccountId)</AccountId>
      					<CampaignType>Search</CampaignType>
			        </GetCampaignsByAccountIdRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='accountinfowithcustomerdata']/*[name()='a:accountinfowithcustomerdata']" Id="asd">
        <Xpath Expr="./*[name()='a:customerid']" Id="Id" Title="Id"/>
        <Xpath Expr="./*[name()='a:customername']" Id="Name" Title="Name"/>
        <Xpath Expr="./*[name()='a:accountname']" Id="AccountName" Title="Account Name"/>
        <Xpath Expr="./*[name()='a:accountid']" Id="AccountId" Title="Account Id"/>
        <Xpath Expr="./*[name()='a:accountnumber']" Id="AccountNumber" Title="Account Number" Converter="Int"/>
        <Xpath Expr="./*[name()='a:accountlifecyclestatus']" Id="Status" Title="Status"/>
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>


  <RazorFunctions>
    <![CDATA[
    string XmlEscape(string unescaped)
    {
      System.Xml.XmlDocument doc = new System.Xml.XmlDocument();
      System.Xml.XmlNode node = doc.CreateElement("root");
      node.InnerText = unescaped;
      return node.InnerXml;
    }

    string XmlUnescape(string escaped)
    {
      System.Xml.XmlDocument doc = new System.Xml.XmlDocument();
      System.Xml.XmlNode node = doc.CreateElement("root");
      node.InnerXml = escaped;
      return node.InnerText;
    }
    ]]>
  </RazorFunctions>
</Suite>