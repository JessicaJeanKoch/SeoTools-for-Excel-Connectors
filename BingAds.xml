<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Ads" Title="Bing Ads" Id="BingAds" RequireVersion="7.0" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/BingAds.xml" HelpUrl="http://seotoolsforexcel.com/bing-ads/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <DefaultOAuthAuthenticator StayAuthenticated="true" TokenName="access_token" AuthUrl="https://login.live.com/oauth20_authorize.srf?client_id=a688826e-d804-4c17-9317-e898b3508c99&amp;scope=bingads.manage&amp;response_type=token&amp;redirect_uri={0}&amp;state=hf7FD437we89"/>

  <Resources>
    <Resource Id="Fail">
      <Fail>
        <XPath Expr="//faultstring"/>
      </Fail>
    </Resource>
  </Resources>

  <RestConnector Id="GetCustomers" Title="Customers" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/getaccountsinfo?view=bingads-12">
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization"><![CDATA[Bearer @(Model.Authenticator.Token)]]></Header>
          <Header Name="SOAPAction">GetCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
          <s:Envelope xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header xmlns="https://bingads.microsoft.com/Customer/v12">
              <Action mustUnderstand="1">GetCustomersInfo</Action>
              <AuthenticationToken i:nil="false">@(Model.Authenticator.Token)</AuthenticationToken>
              <DeveloperToken i:nil="false">119C9YN00G530945</DeveloperToken>
            </s:Header>
            <s:Body>
              <GetCustomersInfoRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <CustomerNameFilter i:nil="false">ValueHere</CustomerNameFilter>
                <TopN>1000</TopN>
              </GetCustomersInfoRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='customersinfo']/*[name()='e16:customerinfo']">
        <Xpath Expr="./*[name()='e16:id']" Id="Id" Title="Id"/>
        <Xpath Expr="./*[name()='e16:name']" Id="Name" Title="Name"/>
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetAccountDetailed" Title="Accounts (Detailed)" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/searchaccounts?view=bingads-12">
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization"><![CDATA[Bearer @(Model.Authenticator.Token)]]></Header>
          <Header Name="SOAPAction">SearchAccounts</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
          <s:Envelope xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header xmlns="https://bingads.microsoft.com/Customer/v12">
              <Action mustUnderstand="1">SearchAccounts</Action>
              <AuthenticationToken i:nil="false">@(Model.Authenticator.Token)</AuthenticationToken>
              <DeveloperToken i:nil="false">119C9YN00G530945</DeveloperToken>
            </s:Header>
            <s:Body>
              <SearchAccountsRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <Predicates xmlns:e263="https://bingads.microsoft.com/Customer/v12/Entities" i:nil="false">
                  <e263:Predicate>
                    <e263:Field i:nil="false">AccountName</e263:Field>
                    <e263:Operator>Contains</e263:Operator>
                    <e263:Value i:nil="false">a</e263:Value>
                  </e263:Predicate>
                </Predicates>
                <Ordering xmlns:e264="https://bingads.microsoft.com/Customer/v12/Entities" i:nil="false">
                  <e264:OrderBy>
                    <e264:Field>Id</e264:Field>
                    <e264:Order>Descending</e264:Order>
                  </e264:OrderBy>
                </Ordering>
                <PageInfo xmlns:e265="https://bingads.microsoft.com/Customer/v12/Entities" i:nil="false">
                  <e265:Index>0</e265:Index>
                  <e265:Size>10</e265:Size>
                </PageInfo>
              </SearchAccountsRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='accounts']/*[name()='a:advertiseraccount']">
        <Xpath Expr="./*[name()='a:id']" Id="Id" Title="Id"/>
        <Xpath Expr="./*[name()='a:billtocustomerid']" Id="BillToCustomerId" Title="Bill to Customer"/>
        <Xpath Expr="./*[name()='a:currencycode']" Id="CurrencyCode" Title="Currency Code"/>
        <Xpath Expr="./*[name()='a:accountfinancialstatus']" Id="FinancialStatus" Title="Financial Status"/>
        <Xpath Expr="./*[name()='a:language']" Id="Language" Title="Language"/>
        <Xpath Expr="./*[name()='a:name']" Id="Name" Title="Name"/>
        <Xpath Expr="./*[name()='a:number']" Id="Number" Title="Account Number"/>
        <Xpath Expr="./*[name()='a:paymentmethodtype']" Id="PaymentMethodType" Title="Payment Method Type"/>
        <Xpath Expr="./*[name()='a:accountlifecyclestatus']" Id="Status" Title="Status"/>
        <Xpath Expr="./*[name()='a:timezone']" Id="Timezone" Title="Timezone"/>
        <Xpath Expr="./*[name()='a:billingthresholdamount']" Id="BillingThresholdAmount" Title="BillingThresholdAmount"/>
        <!--<Xpath Expr="./*[name()='']" Id="" Title=""/>-->
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetAccountsBasic" Title="Accounts (Basic)" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/searchaccounts?view=bingads-12">
    <Parameters>
      <Text Id="Email" Title="Email" Required="true"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">FindAccountsOrCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header>
              <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
              <h:DeveloperToken xmlns:h="https://bingads.microsoft.com/Customer/v12">119C9YN00G530945</h:DeveloperToken>
              <h:Password i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:UserName xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Email)</h:UserName>
            </s:Header>
            <s:Body>
              <FindAccountsOrCustomersInfoRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <Filter/>
                <TopN>1000</TopN>
              </FindAccountsOrCustomersInfoRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='accountinfowithcustomerdata']/*[name()='a:accountinfowithcustomerdata']">
        <Xpath Expr="./*[name()='a:customerid']" Id="Id" Title="Customer Id"/>
        <Xpath Expr="./*[name()='a:customername']" Id="Name" Title="Name"/>
        <Xpath Expr="./*[name()='a:accountname']" Id="AccountName" Title="Account Name"/>
        <Xpath Expr="./*[name()='a:accountid']" Id="AccountId" Title="Account Id"/>
        <Xpath Expr="./*[name()='a:accountnumber']" Id="AccountNumber" Title="Account Number" Converter="Int"/>
        <Xpath Expr="./*[name()='a:accountlifecyclestatus']" Id="Status" Title="Status"/>
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetAccountsHidden" Hidden="true" HelpUrl="https://docs.microsoft.com/en-us/bingads/customer-management-service/searchaccounts?view=bingads-12">
    <Parameters>
      <Text Id="Email" Title="Email" Required="true"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">FindAccountsOrCustomersInfo</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header>
              <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
              <h:DeveloperToken xmlns:h="https://bingads.microsoft.com/Customer/v12">119C9YN00G530945</h:DeveloperToken>
              <h:Password i:nil="true" xmlns:h="https://bingads.microsoft.com/Customer/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:UserName xmlns:h="https://bingads.microsoft.com/Customer/v12">@(Model.Email)</h:UserName>
            </s:Header>
            <s:Body>
              <FindAccountsOrCustomersInfoRequest xmlns="https://bingads.microsoft.com/Customer/v12">
                <Filter/>
                <TopN>1000</TopN>
              </FindAccountsOrCustomersInfoRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://clientcenter.api.bingads.microsoft.com/Api/CustomerManagement/v12/CustomerManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*[name()='accountinfowithcustomerdata']/*[name()='a:accountinfowithcustomerdata']">
        <Compute Id="AccountId">
          <Compute.Expr>
            <![CDATA[
            @{
              string name = "";
              name += Model.CustomerId + "/" + Model.AccId;
            }
            @name
            ]]>
          </Compute.Expr>
          <Xpath Expr="./*[name()='a:customerid']" Id="CustomerId"/>
          <Xpath Expr="./*[name()='a:accountid']" Id="AccId"/>
        </Compute>
        <Compute Id="Name">
          <Compute.Expr>
            <![CDATA[
            @{
              string name = "";
              name += Model.CustomerName + " - " + Model.AccountName;
            }
            @name
            ]]>
          </Compute.Expr>
          <Xpath Expr="./*[name()='a:customername']" Id="CustomerName"/>
          <Xpath Expr="./*[name()='a:accountname']" Id="AccountName"/>
        </Compute>
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="GetCampaigns" Title="Campaigns" HelpUrl="https://docs.microsoft.com/en-us/bingads/campaign-management-service/getcampaignsbyaccountid?view=bingads-12">
    <Parameters>
      <Text Id="Email" Title="Email" Required="true"/>
      <Text Id="AccountId" Title="Account Id" Required="true" Select.Connector="GetAccountsHidden" Select.IdField="AccountId" Select.TitleField="Name"/>
      <Select Id="Type" Title="Type" DefaultValue="Search" Required="true">
        <DataSource>
          <!--MultiSelect-->
          <Item Id="Search" Title="Search"/>
          <Item Id="Shopping" Title="Shopping"/>
          <Item Id="DynamicSearchAds" Title="Dynamic Search Ads"/>
        </DataSource>
      </Select>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">GetCampaignsByAccountId</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            <s:Header>
              <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
              <h:DeveloperToken xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12">119C9YN00G530945</h:DeveloperToken>
              <h:Password i:nil="true" xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
              <h:UserName xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12">@(Model.Email)</h:UserName>
              <h:CustomerId	xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12">@(GetIds(Model.AccountId).Item1)</h:CustomerId>
              <h:CustomerAccountId xmlns:h="https://bingads.microsoft.com/CampaignManagement/v12">@(GetIds(Model.AccountId).Item2)</h:CustomerAccountId>
            </s:Header>
            <s:Body>
              <GetCampaignsByAccountIdRequest	xmlns="https://bingads.microsoft.com/CampaignManagement/v12">
					      <AccountId>@(GetIds(Model.AccountId).Item2)</AccountId>
      					<CampaignType>Search</CampaignType>
			        </GetCampaignsByAccountIdRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://campaign.api.bingads.microsoft.com/Api/Advertiser/CampaignManagement/v12/CampaignManagementService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//campaigns/*">
        <XPath Expr="./id" Id="Id" Title="Id" Converter="String" HelpText=""/>
        <XPath Expr="./name" Id="Name" Title="Name" Converter="String" HelpText=""/>
        <XPath Expr="./status" Id="Status" Title="Status" Converter="String" HelpText=""/>
        <XPath Expr="./dailybudget" Id="Dailybudget" Title="Daily Budget" Converter="String" HelpText=""/>
        <XPath Expr="./description" Id="Description" Title="Description" Converter="String" HelpText=""/>
        <XPath Expr="./campaigntype" Id="Campaigntype" Title="Campaigntype" Converter="String" HelpText=""/>
        <XPath Expr="./biddingscheme" Id="Biddingscheme" Title="Bidding Scheme" Converter="String" HelpText=""/>
        <XPath Expr="./budgettype" Id="Budgettype" Title="Budget Type" Converter="String" HelpText=""/>
        <XPath Expr="./forwardcompatibilitymap" Id="Forwardcompatibilitymap" Title="Forward Compatibility Map" Converter="String" HelpText="" Checked="false"/>
        <XPath Expr="./subtype" Id="Subtype" Title="Subtype" Converter="String" HelpText=""/>
        <XPath Expr="./timezone" Id="Timezone" Title="Timezone" Converter="String" HelpText=""/>
        <XPath Expr="./trackingurltemplate" Id="Trackingurltemplate" Title="Tracking URL Template" Converter="String" HelpText="" Checked="false"/>
        <XPath Expr="./urlcustomparameters" Id="Urlcustomparameters" Title="URL Custompa Pameters" Converter="String" HelpText="" Checked="false"/>
        <XPath Expr="./settings" Id="Settings" Title="Settings" Converter="String" HelpText=""  hecked="false"/>
        <XPath Expr="./budgetid" Id="Budgetid" Title="Budgetid" Converter="String" HelpText="" Checked="false"/>
        <XPath Expr="./languages" Id="Languages" Title="Languages" Converter="String" HelpText=""/>
      </Xpath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="SubmitGenerateReport" Hidden="false" Title="Generate a Report" HelpUrl="https://docs.microsoft.com/en-us/bingads/reporting-service/submitgeneratereport?view=bingads-12">
    <Parameters>
      <Text Id="CampaignId" Debug.DefaultValue="349338690"/>
      <Text Id="AccountId" Title="Account Id" Required="true" Debug.DefaultValue="150145763"/>
      <!--<Select Id="Type" Title="Type"  Debug.DefaultValue="250151008/150145763" DefaultValue="Search" Required="true">-->
        <!--<DataSource>-->
          <!--<Item Id="Search" Title="Search"/>-->
          <!--<Item Id="Shopping" Title="Shopping"/>-->
          <!--<Item Id="DynamicSearchAds" Title="Dynamic Search Ads"/>-->
        <!--</DataSource>-->
      <!--</Select>-->
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">SubmitGenerateReport</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            	<s:Header>
                <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Reporting/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                  <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Reporting/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
                  <h:CustomerAccountId i:nil="true"	xmlns:h="https://bingads.microsoft.com/Reporting/v12"	xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                  <h:CustomerId i:nil="true" xmlns:h="https://bingads.microsoft.com/Reporting/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                  <h:DeveloperToken	xmlns:h="https://bingads.microsoft.com/Reporting/v12">119C9YN00G530945</h:DeveloperToken>
                  <h:Password i:nil="true"	xmlns:h="https://bingads.microsoft.com/Reporting/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                  <h:UserName xmlns:h="https://bingads.microsoft.com/Reporting/v12">dovydas.m@gmail.com</h:UserName>
				    </s:Header>
            <s:Body>
						<SubmitGenerateReportRequest xmlns="https://bingads.microsoft.com/Reporting/v12">
							<ReportRequest i:type="AdGroupPerformanceReportRequest"	xmlns:i="http://www.w3.org/2001/XMLSchema-instance">
								<ExcludeColumnHeaders>false</ExcludeColumnHeaders>
								<ExcludeReportFooter>false</ExcludeReportFooter>
								<ExcludeReportHeader>false</ExcludeReportHeader>
								<Format>Csv</Format>
								<Language>English</Language>
								<ReportName>Ad performance report</ReportName>
								<ReturnOnlyCompleteData>false</ReturnOnlyCompleteData>
								<Aggregation>Summary</Aggregation>
								<Columns>
									<AdGroupPerformanceReportColumn>AdGroupId</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Revenue</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ReturnOnAdSpend</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Clicks</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Impressions</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>AverageCpc</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>AveragePosition</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Ctr</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Spend</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Conversions</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>CostPerConversion</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionSharePercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToBudgetPercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToRankPercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToBidPercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToAdRelevancePercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToExpectedCtrPercent</AdGroupPerformanceReportColumn>
								</Columns>
								<Filter i:nil="true"/>
								<Scope>
									<AccountIds i:nil="true" xmlns:a="http://schemas.microsoft.com/2003/10/Serialization/Arrays"/>
										<AdGroups i:nil="true"/>
										<Campaigns>
											<CampaignReportScope>
												<AccountId>@(Model.AccountId)</AccountId>
												<CampaignId>@(Model.CampaignId)</CampaignId>
											</CampaignReportScope>
										</Campaigns>
									</Scope>
									<Time>
										<CustomDateRangeEnd i:nil="true"/>
										<CustomDateRangeStart i:nil="true"/>
										<PredefinedTime>Today</PredefinedTime>
										<ReportTimeZone i:nil="true"/>
									</Time>
								</ReportRequest>
							</SubmitGenerateReportRequest>
						</s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://reporting.api.bingads.microsoft.com/Api/Advertiser/Reporting/v12/ReportingService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//reportrequestid" Id="ReportId"/>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="PollGenerateReport" HelpUrl="https://docs.microsoft.com/en-us/bingads/reporting-service/pollgeneratereport?view=bingads-12">
    <Parameters>
      <Text Id="CampaignId" Debug.DefaultValue="349338690"/>
      <Text Id="AccountId" Title="Account Id" Required="true" Debug.DefaultValue="150145763"/>
    </Parameters>
    <Prepare>
      <Connector Id="SubmitGenerateReport"/>
    </Prepare>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name="SOAPAction">PollGenerateReport</Header>
        </RequestHeaders>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>text/xml; charset=utf-8</RequestContentType>
        <RequestBody>
          <![CDATA[
           <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
            	<s:Header>
                <h:ApplicationToken i:nil="true" xmlns:h="https://bingads.microsoft.com/Reporting/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                <h:AuthenticationToken xmlns:h="https://bingads.microsoft.com/Reporting/v12">@(Model.Authenticator.Token)</h:AuthenticationToken>
                <h:CustomerAccountId i:nil="true"	xmlns:h="https://bingads.microsoft.com/Reporting/v12"	xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                <h:CustomerId i:nil="true" xmlns:h="https://bingads.microsoft.com/Reporting/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                <h:DeveloperToken	xmlns:h="https://bingads.microsoft.com/Reporting/v12">119C9YN00G530945</h:DeveloperToken>
                <h:Password i:nil="true"	xmlns:h="https://bingads.microsoft.com/Reporting/v12" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"/>
                <h:UserName xmlns:h="https://bingads.microsoft.com/Reporting/v12">dovydas.m@gmail.com</h:UserName>
				    </s:Header>
            <s:Body>
              <PollGenerateReportRequest xmlns="https://bingads.microsoft.com/Reporting/v12">
                <ReportRequestId>@(Model.ReportId)</ReportRequestId>
              </PollGenerateReportRequest>
            </s:Body>
          </s:Envelope>
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://reporting.api.bingads.microsoft.com/Api/Advertiser/Reporting/v12/ReportingService.svc
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*" Id="ReportUrl"/>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>


  <RestConnector Id="Test">
    <Parameters>
      <Text Id="CampaignId" Debug.DefaultValue="349338690"/>
      <Text Id="Email" Debug.DefaultValue="dovydas.m@gmail.com"/>
      <Text Id="AccountId" Title="Account Id" Required="true" Debug.DefaultValue="150145763"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
          @{
            string reportRequestId = "";
            string reporturl = "";

            //Initial CampaignPerformanceReportRequest
            System.Net.HttpWebRequest req = (System.Net.HttpWebRequest)System.Net.WebRequest.Create("https://reporting.api.bingads.microsoft.com/Api/Advertiser/Reporting/v12/ReportingService.svc");
            string generatedBody = getRequestReportBody();
            string html = "";
            req.Method = "POST";
            req.ContentType = "text/xml; charset=utf-8";
            req.Headers["SOAPAction"] = "SubmitGenerateReport";
            var data = Encoding.ASCII.GetBytes(generatedBody);
            req.ContentLength = data.Length;

            using (var stream = req.GetRequestStream())
            {
                stream.Write(data, 0, data.Length);
            }

            using (System.Net.HttpWebResponse response = (System.Net.HttpWebResponse)req.GetResponse())
            using (System.IO.Stream stream = response.GetResponseStream())
            using (System.IO.StreamReader reader = new System.IO.StreamReader(stream))
            {
                html = reader.ReadToEnd();
                Regex regex = new Regex(@"<ReportRequestId>([^<]+)");
                Match match = regex.Match(html);
                reportRequestId = match.Groups[1].Value;
                //throw new Exception(reportRequestId);

            }

            bool finished = false;
            while (finished == false){
              System.Net.HttpWebRequest request = (System.Net.HttpWebRequest)System.Net.WebRequest.Create("https://reporting.api.bingads.microsoft.com/Api/Advertiser/Reporting/v12/ReportingService.svc");
              html = "";

              string genBody = getPollBody(reportRequestId);
              request.Method = "POST";
              request.ContentType = "text/xml; charset=utf-8";
              request.Headers["SOAPAction"] = "PollGenerateReport";
              var bodyData = Encoding.ASCII.GetBytes(genBody);
              request.ContentLength = bodyData.Length;

              using (var stream = request.GetRequestStream())
              {
                  stream.Write(bodyData, 0, bodyData.Length);
              }

              using (System.Net.HttpWebResponse response = (System.Net.HttpWebResponse)request.GetResponse())
              using (System.IO.Stream stream = response.GetResponseStream())
              using (System.IO.StreamReader reader = new System.IO.StreamReader(stream))
              {
                  html = reader.ReadToEnd();
              }
              finished = true;
             }
            }
          https://www.google.com/
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Xpath Expr="//*" Id="test"/>
    </Parse>
  </RestConnector>

  <ArchiveConnector Id="GetReport" FileNameRegex=".+\.csv">
    <Parameters>
      <Text Id="ReportUrl" Required="true" Debug.DefaultValue="https://x.dovydasm.com/t/rep/deflate.zip"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
          @(Model.ReportUrl)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Csv Separator="," HasHeader="true">
        <Field Id="AdGroupId" Title="Ad Group Id" HelpText="The Bing Ads assigned identifier of an ad group." Converter="Double"/>
        <Field Id="Revenue" Title="Revenue" HelpText="The revenue optionally reported by the advertiser as a result of conversions." Converter="Double"/>
        <Field Id="ReturnOnAdSpend" Title="Return On Ad Spend" Converter="Double" HelpText="The return on ad spend (ROAS). The formula for calculating the ROAS is (Revenue / Spend)."/>
        <Field Id="Clicks" Title="Clicks" Converter="Int" HelpText="Clicks are what you pay for. Clicks typically include a customer clicking an ad on a search results page or on a website on the search network. Clicks can also come from other sources (for example, spiders, robots, and test servers)"/>
        <Field Id="Impressions" Title="Impressions" Converter="Int" HelpText="The number of times an ad has been displayed on search results pages."/>
        <Field Id="AverageCpc" Title="Average Cpc" Converter="Double" HelpText="The average cost per click (CPC). The total cost of all clicks on an ad divided by the number of clicks. "/>
        <Field Id="AveragePosition"  Title="Average Position" Converter="Double" HelpText="The average position of the ad on a webpage."/>
        <Field Id="Ctr" Title="CTR" HelpText="The click-through rate (CTR) is the number of times an ad was clicked, divided by the number of times the ad was shown (impressions"/>
        <Field Id="Spend" Title="Spend" Converter="Double" HelpText="The cost per click (CPC) summed for each click."/>
        <Field Id="Conversions" Title="Conversions" Converter="Double" HelpText="The number of conversions. A conversion is the completion of an action by a customer after viewing your ad. "/>
        <Field Id="CostPerConversion" Title="Cost Per Conversion" Converter="Double" HelpText="The cost per conversion. The formula for calculating the cost per conversion is (Spend / Conversions). "/>
        <Field Id="ImpressionSharePercent" Title="Impression Share Percent" HelpText="The estimated percentage of impressions, out of the total available impressions in the market you were targeting. "/>
        <Field Id="ImpressionLostToBudgetPercent" Title="Impression Lost To Budget Percent" HelpText=""/>
        <Field Id="ImpressionLostToRankPercent" Title="Impression Lost To Rank Percent" Converter="Auto" HelpText=""/>
        <Field Id="ImpressionLostToBidPercent" Title="Impression Lost To Bid Percent" HelpText=""/>
        <Field Id="ImpressionLostToAdRelevancePercent" Title="Impression Lost To Ad Relevance Percent" HelpText=""/>
        <Field Id="ImpressionLostToExpectedCtrPercent" Title="Impression Lost To Expected Ctr Percent" HelpText=""/>
      </Csv>
    </Parse>
  </ArchiveConnector>



  <RazorFunctions>
    <![CDATA[
    string XmlEscape(string unescaped)
    {
      System.Xml.XmlDocument doc = new System.Xml.XmlDocument();
      System.Xml.XmlNode node = doc.CreateElement("root");
      node.InnerText = unescaped;
      return node.InnerXml;
    }

    string XmlUnescape(string escaped)
    {
      System.Xml.XmlDocument doc = new System.Xml.XmlDocument();
      System.Xml.XmlNode node = doc.CreateElement("root");
      node.InnerXml = escaped;
      return node.InnerText;
    }

    Tuple<string,string> GetIds(string combined){
      string customerId = "";
      string accountId = "";
      if (!String.IsNullOrWhiteSpace(combined))
        {
            int charLocation = combined.IndexOf('/');
            if (charLocation > 0)
            {
                customerId = combined.Substring(0, charLocation);
                if (charLocation < combined.Length - 1){
                  accountId = combined.Substring(charLocation + 1);
                }
            }
        }
       return new Tuple<string,string>(customerId, accountId);
    }

    string getRequestReportBody (){
    string template = @"
    <s:Envelope xmlns:s=""http://schemas.xmlsoap.org/soap/envelope/"">
            	<s:Header>
                <h:ApplicationToken i:nil=""true"" xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance""/>
                  <h:AuthenticationToken xmlns:h=""https://bingads.microsoft.com/Reporting/v12"">{0}</h:AuthenticationToken>
                  <h:CustomerAccountId i:nil=""true""	xmlns:h=""https://bingads.microsoft.com/Reporting/v12""	xmlns:i=""http://www.w3.org/2001/XMLSchema-instance""/>
                  <h:CustomerId i:nil=""true"" xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance""/>
                  <h:DeveloperToken	xmlns:h=""https://bingads.microsoft.com/Reporting/v12"">119C9YN00G530945</h:DeveloperToken>
                  <h:Password i:nil=""true""	xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance""/>
                  <h:UserName xmlns:h=""https://bingads.microsoft.com/Reporting/v12"">{1}</h:UserName>
				    </s:Header>
            <s:Body>
						<SubmitGenerateReportRequest xmlns=""https://bingads.microsoft.com/Reporting/v12"">
							<ReportRequest i:type=""AdGroupPerformanceReportRequest""	xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"">
								<ExcludeColumnHeaders>false</ExcludeColumnHeaders>
								<ExcludeReportFooter>true</ExcludeReportFooter>
								<ExcludeReportHeader>true</ExcludeReportHeader>
								<Format>Csv</Format>
								<Language>English</Language>
								<ReportName>Ad performance report</ReportName>
								<ReturnOnlyCompleteData>false</ReturnOnlyCompleteData>
								<Aggregation>Summary</Aggregation>
								<Columns>
									<AdGroupPerformanceReportColumn>AdGroupId</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Revenue</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ReturnOnAdSpend</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Clicks</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Impressions</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>AverageCpc</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>AveragePosition</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Ctr</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Spend</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>Conversions</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>CostPerConversion</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionSharePercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToBudgetPercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToRankPercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToBidPercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToAdRelevancePercent</AdGroupPerformanceReportColumn>
									<AdGroupPerformanceReportColumn>ImpressionLostToExpectedCtrPercent</AdGroupPerformanceReportColumn>
								</Columns>
								<Filter i:nil=""true""/>
								<Scope>
									<AccountIds i:nil=""true"" xmlns:a=""http://schemas.microsoft.com/2003/10/Serialization/Arrays""/>
										<AdGroups i:nil=""true""/>
										<Campaigns>
											<CampaignReportScope>
												<AccountId>{2}</AccountId>
												<CampaignId>{3}</CampaignId>
											</CampaignReportScope>
										</Campaigns>
									</Scope>
									<Time>
										<CustomDateRangeEnd i:nil=""true""/>
										<CustomDateRangeStart i:nil=""true""/>
										<PredefinedTime>Today</PredefinedTime>
										<ReportTimeZone i:nil=""true""/>
									</Time>
								</ReportRequest>
							</SubmitGenerateReportRequest>
						</s:Body>
          </s:Envelope>
    ";

    string filled = String.Format(template, Model.Authenticator.Token, Model.Email, Model.AccountId, Model.CampaignId);
    return filled;
    }

     string getPollBody (string requestId){
      string template = @"
      <s:Envelope xmlns:s=""http://schemas.xmlsoap.org/soap/envelope/"">
         <s:Header>
           <h:ApplicationToken i:nil=""true"" xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"" />
           <h:AuthenticationToken xmlns:h=""https://bingads.microsoft.com/Reporting/v12"">{0}</h:AuthenticationToken>
           <h:CustomerAccountId i:nil=""true"" xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"" />
           <h:CustomerId i:nil=""true"" xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"" />
           <h:DeveloperToken xmlns:h=""https://bingads.microsoft.com/Reporting/v12"">1L9L5BYH550</h:DeveloperToken>
           <h:Password i:nil=""true"" xmlns:h=""https://bingads.microsoft.com/Reporting/v12"" xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"" />
           <h:UserName xmlns:h=""https://bingads.microsoft.com/Reporting/v12"">{1}</h:UserName>
          </s:Header>
          <s:Body>
           <PollGenerateReportRequest xmlns=""https://bingads.microsoft.com/Reporting/v12"">
               <ReportRequestId>{2}</ReportRequestId>
           </PollGenerateReportRequest>
          </s:Body>
      </s:Envelope>
      ";

      string filled = String.Format(template, Model.Authenticator.Token, Model.Email, requestId);
      return filled;
      }
    ]]>
  </RazorFunctions>
</Suite>